<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coachella Valley Agricultural Communities: Updated Mind Map</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
      color: #2c3e50;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #2c3e50;
      font-size: 22px;
    }
    
    h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 30px;
      color: #2c3e50;
      font-size: 18px;
      font-weight: normal;
    }
    
    #mind-map {
      width: 100%;
      height: 700px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: white;
      overflow: auto;
      position: relative;
    }
    
    .legend {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      font-size: 14px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 8px;
    }
    
    footer {
      text-align: center;
      margin-top: 30px;
      color: #7f8c8d;
      font-size: 12px;
    }
    
    .instructions {
      text-align: center;
      margin: 15px 0;
      font-style: italic;
      color: #7f8c8d;
    }

    .node circle {
      fill: #fff;
      stroke-width: 2px;
    }

    .node text {
      font: 12px sans-serif;
    }

    .link {
      fill: none;
      stroke-width: 2px;
    }

    .tooltip {
      position: absolute;
      padding: 10px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 300px;
      font-size: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 100;
    }
    
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    
    .controls button {
      padding: 5px 10px;
      margin-right: 5px;
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .controls button:hover {
      background-color: #e9ecef;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>California Agricultural Land Equity Task Force</h1>
    <h2>Coachella Valley Listening Session: Findings & Synthesis</h2>
    
    <div class="instructions">
      <p>Click on nodes to expand/collapse. Drag the diagram to reposition. Hover over nodes for more details.</p>
    </div>
    
    <div id="mind-map">
      <div class="controls">
        <button id="expand-all">Expand All</button>
        <button id="collapse-all">Collapse All</button>
      </div>
    </div>
    
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background-color: #3498db;"></div>
        <span>Group 1 Concerns</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #2ecc71;"></div>
        <span>Group 2 Concerns</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #e74c3c;"></div>
        <span>Group 3 Concerns</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #f39c12;"></div>
        <span>Common Challenges</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #9b59b6;"></div>
        <span>Integrated Solutions</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #34495e;"></div>
        <span>Proposed State Actions</span>
      </div>
    </div>
    
    <footer>
      Source: California Land Equity Task Force - Coachella Valley Listening Session, February 2025
    </footer>
  </div>

  <!-- D3.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script>
    // Mind map data structure
    const data = {
      name: "Coachella Valley Listening Session",
      color: "#34495e",
      details: "Findings from the California Land Equity Task Force with agricultural communities including migrant farmworkers, tenant farmers, small farmers, and huerto operators",
      children: [
        {
          name: "Group 1 Concerns",
          color: "#3498db",
          details: "Distinct challenges identified by Group 1 participants",
          children: [
            { 
              name: "Land Tenure Insecurity", 
              color: "#3498db",
              details: "USDA doesn't help renters, landlord restrictions on harvesting and business activities, concerns about succession - no one to leave land to" 
            },
            { 
              name: "Certification Challenges", 
              color: "#3498db",
              details: "Different food safety certifications needed depending on the buyer (Costco, Winco, etc.), need for guidance navigating certification requirements"
            },
            { 
              name: "Labor Management", 
              color: "#3498db",
              details: "Trust issues with workers (mentioned lawsuits), need more time to dedicate to crops, too many political issues with hiring"
            },
            { 
              name: "Agricultural Losses", 
              color: "#3498db",
              details: "Lost 100 acres of green beans, lost significant moringa crops, climate and temperature limitations in Coachella restrict what they can grow"
            },
            { 
              name: "Community Resources", 
              color: "#3498db",
              details: "Interest in creating a community nursery in a parking lot for 12 trailers, interest in forming a union for mutual support"
            },
            { 
              name: "Financial Support Needs", 
              color: "#3498db",
              details: "Working with large companies isn't profitable due to low payments, need practical help beyond talk, more help for machinery and equipment"
            }
          ]
        },
        {
          name: "Group 2 Concerns",
          color: "#2ecc71",
          details: "Distinct challenges identified by Group 2 participants",
          children: [
            { 
              name: "Land & Huertos", 
              color: "#2ecc71",
              details: "Various herbs for home remedies, vegetables, fruits in gardens. Blueberries, grapefruits, citrus, strawberries, and pomegranates common. Natural pest management strategies important."
            },
            { 
              name: "Intermediaries & Pricing", 
              color: "#2ecc71",
              details: "Complaints that LA wholesalers undercut prices of their produce. Rate this market access over land access given how they prefer to rent due to potential water & property tax costs from land ownership."
            },
            { 
              name: "Youth & Education", 
              color: "#2ecc71",
              details: "Agricultural skills learned through family rather than formal education. Strong interest in schools teaching agricultural skills and business concepts."
            },
            { 
              name: "Cooperative Models", 
              color: "#2ecc71",
              details: "Mixed experiences with cooperative farming, challenges with water access and distribution in cooperatives, preference for starting small before cooperatives."
            },
            { 
              name: "Government Support", 
              color: "#2ecc71",
              details: "Concerns about restrictive regulations especially regarding pest management, preference for natural methods, desire for programs that understand small-scale operations."
            },
            { 
              name: "Infrastructure Issues", 
              color: "#2ecc71",
              details: "Complaints about not being allowed to build cold storage due to zoning regulations, need for more help with huerto commercialization."
            }
          ]
        },
        {
          name: "Group 3 Concerns",
          color: "#e74c3c",
          details: "Distinct challenges identified by Group 3 participants",
          children: [
            { 
              name: "Business Growth", 
              color: "#e74c3c",
              details: "Goals to make a stable living for families, grow their businesses, provide quality food to surrounding communities"
            },
            { 
              name: "Tools & Materials Cost", 
              color: "#e74c3c",
              details: "High costs of materials, particularly chemicals. Specialized tools aren't readily available like construction tools."
            },
            { 
              name: "Pricing Issues", 
              color: "#e74c3c",
              details: "Large corporations buy at very low prices and resell at higher prices; farmers do all the work but corporations reap the benefits."
            },
            { 
              name: "Financial Barriers", 
              color: "#e74c3c",
              details: "Unfavorable or nonexistent loans, costly requirements they aren't always aware of, need for better loans with favorable terms."
            },
            { 
              name: "Information Access", 
              color: "#e74c3c",
              details: "Lack of centralized information, need for continuous outreach when policies change, centralized access to information and tools."
            },
            { 
              name: "Cooperative Support", 
              color: "#e74c3c",
              details: "Need for a cooperative to support smaller farmers with resources, information, and tools in a changing agricultural landscape."
            }
          ]
        },
        {
          name: "Common Challenges",
          color: "#f39c12",
          details: "Challenges shared across all three groups during the listening session",
          children: [
            { 
              name: "Market Access & Fair Pricing", 
              color: "#f39c12",
              details: "Los Angeles wholesalers undercutting producers, difficulty securing fair prices, limited market connections, better market access prioritized over land ownership."
            },
            { 
              name: "Insurance & Climate Vulnerability", 
              color: "#f39c12",
              details: "Significant crop losses due to extreme weather events, inadequate insurance options for small producers, climate impacts on production."
            },
            { 
              name: "Financial & Regulatory Complexity", 
              color: "#f39c12",
              details: "Frustration with navigating complex regulatory environments not designed for small-scale operations, need for centralized information resources. Also lack of favorable loans avaiable to these participants, particularly those who often do not meet mainstream industry criteria."
            },
            { 
              name: "Water Affordability & Land Tenure", 
              color: "#f39c12",
              details: "High water costs impact viability of land ownership, water expenses fundamentally shape agricultural decision-making in the region. Renting also limits access to government assistance."
            },
            { 
              name: "Educational Improvement", 
              color: "#f39c12",
              details: "Desire for improved agricultural education that presents diverse career pathways beyond manual labor, concern about intergenerational mobility."
            }
          ]
        },
        {
          name: "Community-Proposed Integrated Solutions",
          color: "#9b59b6",
          details: "Comprehensive solutions designed to address both common and group-specific challenges",
          children: [
            {
              name: "Tiered Support Systems",
              color: "#9b59b6",
              details: "Support programs for various stages of agricultural development: from subsistence huertos to growth-oriented small businesses",
              children: [
                { 
                  name: "Entry-level support for home gardens", 
                  color: "#9b59b6", 
                  details: "Programs and resources for household-scale agricultural production"
                },
                { 
                  name: "Intermediate assistance for small plot operations", 
                  color: "#9b59b6",
                  details: "Support for farmers transitioning from subsistence to commercial production" 
                },
                { 
                  name: "Advanced resources for expanding operations", 
                  color: "#9b59b6",
                  details: "Technical and financial resources for growing agricultural enterprises"
                },
                { 
                  name: "Progressive pathways respecting aspirations", 
                  color: "#9b59b6",
                  details: "Creating pathways for progression while respecting different goals and aspirations"
                }
              ]
            },
            {
              name: "Cooperative Models with Clear Governance",
              color: "#9b59b6",
              details: "Addressing challenges in collective approaches with transparent structures and public oversight",
              children: [
                { 
                  name: "Clear governance protocols", 
                  color: "#9b59b6",
                  details: "Establishing clear procedures for cooperative decision-making"  
                },
                { 
                  name: "Transparent decision-making", 
                  color: "#9b59b6",
                  details: "Open and clear processes for collective decisions"  
                },
                { 
                  name: "Equitable resource allocation", 
                  color: "#9b59b6",
                  details: "Fair distribution of resources among cooperative members"  
                },
                { 
                  name: "Incremental trust-building", 
                  color: "#9b59b6",
                  details: "Starting with small-scale collaborations to build trust over time"  
                }
              ]
            },
            {
              name: "Comprehensive Educational Strategy",
              color: "#9b59b6",
              details: "Transforming agricultural education to integrate multiple visions across groups",
              children: [
                { 
                  name: "Traditional knowledge transmission", 
                  color: "#9b59b6",
                  details: "Honoring and preserving traditional agricultural practices"  
                },
                { 
                  name: "Technical and professional pathways", 
                  color: "#9b59b6",
                  details: "Building pathways to technical and professional roles in agriculture"  
                },
                { 
                  name: "Multi-level educational programs", 
                  color: "#9b59b6",
                  details: "Programs spanning from basic skills to advanced technical knowledge"  
                },
                { 
                  name: "Diverse career options", 
                  color: "#9b59b6",
                  details: "Presenting diverse options while honoring traditional practices"  
                }
              ]
            },
            {
              name: "Multi-Level Market Development",
              color: "#9b59b6",
              details: "Different scales of production require varied market access solutions",
              children: [
                { 
                  name: "Local farmers' markets", 
                  color: "#9b59b6",
                  details: "Direct consumer sales opportunities for small producers"  
                },
                { 
                  name: "Aggregation systems", 
                  color: "#9b59b6",
                  details: "Systems giving medium-sized operations better negotiating power"  
                },
                { 
                  name: "Digital platforms", 
                  color: "#9b59b6",
                  details: "Technologies connecting producers to appropriate buyers"  
                },
                { 
                  name: "Price transparency mechanisms", 
                  color: "#9b59b6",
                  details: "Systems addressing concerns about wholesalers undercutting prices"  
                }
              ]
            },
            {
              name: "Integrated Regulatory Navigation",
              color: "#9b59b6",
              details: "Coordinated assistance programs to help navigate complex requirements",
              children: [
                { 
                  name: "Personalized guidance", 
                  color: "#9b59b6",
                  details: "Individualized help through regulatory processes"  
                },
                { 
                  name: "Centralized information access", 
                  color: "#9b59b6",
                  details: "Single source for regulatory information across agencies"  
                },
                { 
                  name: "Multilingual materials", 
                  color: "#9b59b6",
                  details: "Resources in multiple languages for diverse communities"  
                },
                { 
                  name: "Simplified pathways", 
                  color: "#9b59b6",
                  details: "Streamlined processes for small-scale producers while maintaining standards"  
                }
              ]
            },
            {
              name: "Participatory Governance Structure",
              color: "#9b59b6",
              details: "Ensuring meaningful inclusion in decision-making across all groups",
              children: [
                { 
                  name: "Institutionalized community participation", 
                  color: "#9b59b6",
                  details: "Formalized ongoing community input beyond initial consultations"  
                },
                { 
                  name: "Transparent implementation reporting", 
                  color: "#9b59b6",
                  details: "Clear reporting on progress and outcomes of initiatives"  
                },
                { 
                  name: "Regular community forums", 
                  color: "#9b59b6",
                  details: "Ongoing dialog with community members & respective organizations"  
                },
                { 
                  name: "Diverse representation", 
                  color: "#9b59b6",
                  details: "Ensuring governance represents the full spectrum of agricultural operations"  
                }
              ]
            }
          ]
        },
        {
          name: "Participant-Proposed State Actions",
          color: "#34495e",
          details: "Specific policy and program recommendations for government agencies",
          children: [
            { 
              name: "Publicly-Funded Local Food Hubs", 
              color: "#34495e",
              details: "State government establishing publicly-funded local food hubs to address market access challenges" 
            },
            { 
              name: "Rural Zoning Code Reform", 
              color: "#34495e",
              details: "State and county governments reforming publicly-administered rural zoning codes to remove infrastructure barriers"
            },
            { 
              name: "Public Disaster Insurance Expansion", 
              color: "#34495e",
              details: "State legislature mandating expanded public disaster insurance accessibility for small and tenant farmers"
            },
            { 
              name: "State-Funded Huerto Development Program", 
              color: "#34495e",
              details: "State government establishing a program to support home gardens and provide pathways to commercialization"
            },
            { 
              name: "Public Agricultural Loan Programs", 
              color: "#34495e",
              details: "State financial agencies implementing publicly-administered loan programs designed for small farmers"
            },
            { 
              name: "K-12 Agricultural Curriculum Reform", 
              color: "#34495e",
              details: "Diversifying agricultural career exposure & education in public school curriculum. Offering insights of agronomy, engineering, & business sides of agriculture for children."
            },
            { 
              name: "Publicly-Staffed Navigator Program", 
              color: "#34495e",
              details: "State agricultural departments creating navigator programs to help with regulatory complexity"
            },
            { 
              name: "Community Water Systems Support", 
              color: "#34495e",
              details: "State water boards establishing publicly-supported community water systems with democratic governance"
            },
            { 
              name: "Cooperative Distribution Networks", 
              color: "#34495e",
              details: "State support for publicly-backed cooperative distribution networks to overcome market access barriers"
            }
          ]
        }
      ]
    };

    // Set up the visualization dimensions
    const width = document.getElementById('mind-map').clientWidth;
    const height = document.getElementById('mind-map').clientHeight;
    const margin = {top: 20, right: 120, bottom: 20, left: 120};
    
    // Create the SVG container
    const svg = d3.select('#mind-map')
      .append('svg')
      .attr('width', width)
      .attr('height', height);
    
    const g = svg.append('g')
      .attr('transform', `translate(${margin.left}, ${margin.top})`);
    
    // Add zoom behavior
    const zoom = d3.zoom()
      .scaleExtent([0.5, 2])
      .on('zoom', (event) => {
        g.attr('transform', event.transform);
      });
      
    svg.call(zoom);
    
    // Create tooltip div
    const tooltip = d3.select('body').append('div')
      .attr('class', 'tooltip');
    
    // Create a hierarchical layout
    const tree = d3.tree()
      .size([height - margin.top - margin.bottom, width - margin.left - margin.right - 200]);
    
    // Create the root node
    let root = d3.hierarchy(data);
    
    // Initialize counter for node IDs
    let nodeIdCounter = 0;
    
    // Assign IDs to nodes for tracking and store original data
    root.descendants().forEach(d => {
      d.id = nodeIdCounter++;
      // Store original data to be able to reconstruct the tree later
      d.data.originalChildren = d.data.children ? [...d.data.children] : null;
    });
    
    // Initial positioning
    root.x0 = height / 2;
    root.y0 = 0;
    
    // Collapse all children initially except main categories
    root.children.forEach(collapse);
    
    // Function to collapse nodes
    function collapse(d) {
      if (d.children) {
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
      }
    }
    
    // Update the tree visualization
    update(root);
    
    // Function to update the visualization
    function update(source) {
      // Compute the new tree layout
      const treeData = tree(root);
      
      // Get all nodes and links
      const nodes = treeData.descendants();
      const links = treeData.links();
      
      // Normalize for fixed-depth
      nodes.forEach(d => {
        d.y = d.depth * 180; // Horizontal spacing
      });
      
      // **************** Nodes section ****************
      
      // Update the nodes
      const node = g.selectAll('g.node')
        .data(nodes, d => d.id);
      
      // Enter new nodes
      const nodeEnter = node.enter().append('g')
        .attr('class', 'node')
        .attr('transform', d => `translate(${source.y0}, ${source.x0})`)
        .on('click', (event, d) => {
          // Toggle children on click
          if (d.children) {
            d._children = d.children;
            d.children = null;
          } else {
            d.children = d._children;
            d._children = null;
          }
          update(d);
        })
        .on('mouseover', (event, d) => {
          tooltip.transition()
            .duration(200)
            .style('opacity', .9);
          tooltip.html(`<strong>${d.data.name}</strong><br>${d.data.details}`)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', () => {
          tooltip.transition()
            .duration(500)
            .style('opacity', 0);
        });
      
      // Add circles to the nodes
      nodeEnter.append('circle')
        .attr('r', 1e-6)
        .style('fill', d => d._children ? d.data.color : '#fff')
        .style('stroke', d => d.data.color);
      
      // Add labels to the nodes
      nodeEnter.append('text')
        .attr('dy', '.35em')
        .attr('x', d => d.children || d._children ? -13 : 13)
        .attr('text-anchor', d => d.children || d._children ? 'end' : 'start')
        .text(d => d.data.name)
        .style('fill-opacity', 1e-6);
      
      // Update existing nodes
      const nodeUpdate = nodeEnter.merge(node);
      
      // Transition nodes to their new position
      nodeUpdate.transition()
        .duration(750)
        .attr('transform', d => `translate(${d.y}, ${d.x})`);
      
      // Update node attributes and style
      nodeUpdate.select('circle')
        .attr('r', d => d.depth === 0 ? 10 : 6)
        .style('fill', d => d._children ? d.data.color : '#fff')
        .style('stroke', d => d.data.color)
        .attr('cursor', 'pointer');
      
      nodeUpdate.select('text')
        .style('fill-opacity', 1)
        .attr('font-weight', d => d.depth <= 1 ? 'bold' : 'normal');
      
      // Remove exiting nodes
      const nodeExit = node.exit().transition()
        .duration(750)
        .attr('transform', d => `translate(${source.y}, ${source.x})`)
        .remove();
      
      // Reduce the node circles size to 0
      nodeExit.select('circle')
        .attr('r', 1e-6);
      
      // Fade out the text
      nodeExit.select('text')
        .style('fill-opacity', 1e-6);
      
      // **************** Links section ****************
      
      // Update the links
      const link = g.selectAll('path.link')
        .data(links, d => d.target.id);
      
      // Enter new links
      const linkEnter = link.enter().insert('path', 'g')
        .attr('class', 'link')
        .attr('d', d => {
          const o = {x: source.x0, y: source.y0};
          return diagonal(o, o);
        })
        .style('stroke', d => d.target.data.color)
        .style('opacity', 0.7);
      
      // Update existing links
      const linkUpdate = linkEnter.merge(link);
      
      // Transition links to their new position
      linkUpdate.transition()
        .duration(750)
        .attr('d', d => diagonal(d.source, d.target))
        .style('stroke', d => d.target.data.color);
      
      // Remove exiting links
      link.exit().transition()
        .duration(750)
        .attr('d', d => {
          const o = {x: source.x, y: source.y};
          return diagonal(o, o);
        })
        .remove();
      
      // Store the old positions for transition
      nodes.forEach(d => {
        d.x0 = d.x;
        d.y0 = d.y;
      });
      
      // Creates a curved (diagonal) path from parent to child nodes
      function diagonal(s, d) {
        return `M ${s.y} ${s.x}
                C ${(s.y + d.y) / 2} ${s.x},
                  ${(s.y + d.y) / 2} ${d.x},
                  ${d.y} ${d.x}`;
      }
    }
    
    // Improved function to expand ALL nodes at ANY state
    function expandAll() {
      // Recursive function to expand all nodes
      function expandRecursive(node) {
        // Expand this node first if it has hidden children
        if (node._children) {
          node.children = node._children;
          node._children = null;
        }
        
        // Then expand all visible children recursively
        if (node.children) {
          node.children.forEach(expandRecursive);
        }
      }
      
      // Start from the root
      expandRecursive(root);
      
      // Update the visualization
      update(root);
    }
    
    // Improved function to collapse ALL nodes at ANY state, except the root's immediate children
    function collapseAll() {
      // Recursive function to collapse all nodes
      function collapseRecursive(node) {
        // First collapse all children recursively
        if (node.children) {
          node.children.forEach(collapseRecursive);
          
          // If this is not an immediate child of root, collapse it
          if (node.parent && node.parent !== root) {
            node._children = node.children;
            node.children = null;
          }
        }
      }
      
      // Handle the immediate children of root separately
      if (root.children) {
        root.children.forEach(child => {
          // First collapse all descendants recursively
          if (child.children) {
            child.children.forEach(collapseRecursive);
            
            // Then collapse this child's children
            child._children = child.children;
            child.children = null;
          }
        });
      }
      
      // Update the visualization
      update(root);
    }
    
    // Immediately set up the event listeners for the buttons
    document.getElementById('expand-all').addEventListener('click', expandAll);
    document.getElementById('collapse-all').addEventListener('click', collapseAll);
    
    // Handle window resize
    window.addEventListener('resize', () => {
      const newWidth = document.getElementById('mind-map').clientWidth;
      const newHeight = document.getElementById('mind-map').clientHeight;
      
      svg.attr('width', newWidth)
         .attr('height', newHeight);
      
      tree.size([newHeight - margin.top - margin.bottom, newWidth - margin.left - margin.right - 200]);
      
      update(root);
    });
  </script>
</body>
</html>
